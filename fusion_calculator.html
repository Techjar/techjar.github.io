<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Factorio Fusion Reactor Calculator</title>
	<style>
		body {
			background: #1e1e1e;
			color: #ddd;
			padding: 2rem;
			font-family: sans-serif;
			display: flex;
			gap: 10px;
			align-items: flex-start;
		}

		.controls {
			margin-bottom: 1rem;
		}

		.controls button {
			margin-right: 0.5rem;
			padding: 0.5rem 1rem;
			font-size: 1rem;
			background: #2e2e2e;
			color: #ddd;
			border: 1px solid #444;
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.1s, border-color 0.1s;
		}

		.controls button:hover {
			background: #3e3e3e;
		}

		.controls select {
			background-color: #333;
			color: #fff;
			border: 1px solid #555;
			border-radius: 4px;
			padding: 0.5rem 1.7rem 0.5rem 1rem;
			font-size: 1rem;
			cursor: pointer;
			appearance: none;
			-webkit-appearance: none;
			-moz-appearance: none;
			background-image: url("data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='6'><path d='M0,0 L5,6 L10,0' fill='white'/></svg>");
			background-repeat: no-repeat;
			background-position: right 10px center;
			background-size: 10px 6px;
			transition: background-color 0.1s, border-color 0.1s;
		}

		.controls select:hover {
			background-color: #444;
			border-color: #777;
		}
		
		.controls select:focus {
			outline: none;
			border-color: #999;
		}

		.grid {
			display: flex;
			gap: 10px;
			flex-direction: column;
		}

		.grid.horizontal {
			padding-right: 65px;
		}

		.grid.vertical {
			flex-direction: row;
			padding-bottom: 65px;
		}

		.row, .column {
			display: flex;
			gap: 10px;
		}

		.column {
			flex-direction: column;
		}

		.offset-h {
			transform: translateX(55px);
		}

		.offset-v {
			transform: translateY(55px);
		}

		.cell {
			width: 100px;
			height: 100px;
			background: center no-repeat #262626;
			border: 2px solid #444;
			box-sizing: border-box;
			cursor: pointer;
			position: relative;
			transition: background-color 0.1s, border-color 0.1s;
		}
		
		.cell:hover {
			background-color: #363636;
		}

		.cell.placed {
			background-image: url('https://wiki.factorio.com/images/Fusion_reactor.png');
		}

		.cell span {
			position: absolute;
			font-size: 12px;
			text-align: center;
			bottom: 1px;
			width: 100%;
			pointer-events: none;
		}
		
		.results {
			border: 2px solid #444;
			padding: 0;
			border-spacing: 0;
		}
		
		.results tr:not(:last-child) td {
			border-bottom: 2px solid #444;
		}
		
		.results td {
			margin: 0;
			padding: 10px;
		}
		
		.results td:not(:last-child) {
			border-right: 2px solid #444;
		}
	</style>
</head>
<body>

<div>
<div class="controls">
	<button onclick="addRow()">+ Row</button>
	<button onclick="removeRow()">- Row</button>
	<button onclick="addColumn()">+ Column</button>
	<button onclick="removeColumn()">- Column</button>
	<button id="toggleoffsetmode" onclick="toggleOffsetMode()">Switch to Horizontal</button>
	<button onclick="clearCells()">Clear Layout</button>
</div>

<div id="grid" class="grid"></div>
</div>

<div>
<div class="controls">
	<select id="quality" onchange="calculateResults()">
		<option value="1.0">Normal Quality</option>
		<option value="1.3">Uncommon Quality</option>
		<option value="1.6">Rare Quality</option>
		<option value="1.9">Epic Quality</option>
		<option value="2.5">Legendary Quality</option>
	</select>
</div>

<table class="results">
	<tr>
		<td><img src="https://wiki.factorio.com/images/Substation.png"></td>
		<td id="power"></td>
	</tr>
	<tr>
		<td><img src="https://wiki.factorio.com/images/Fusion_reactor.png"></td>
		<td id="reactors"></td>
	</tr>
	<tr>
		<td><img src="https://wiki.factorio.com/images/Fusion_generator.png"></td>
		<td id="generators"></td>
	</tr>
	<tr>
		<td><img src="https://wiki.factorio.com/images/Fusion_power_cell.png"></td>
		<td id="fusioncells"></td>
	</tr>
	<tr>
		<td><img src="https://wiki.factorio.com/images/Fluoroketone_%28cold%29_barrel.png"></td>
		<td id="fluoroketone"></td>
	</tr>
	<tr>
		<td><img src="https://wiki.factorio.com/images/Fluoroketone_%28hot%29.png"></td>
		<td id="hot_fluoroketone"></td>
	</tr>
</table>
</div>

<script>
	function getItemOrDefault(item, def) {
		if (localStorage.getItem(item) !== null)
			return localStorage.getItem(item);
		return def;
	}
	
	const grid = document.getElementById('grid');

	let numRows = parseInt(getItemOrDefault('numRows', 5));
	let numCols = parseInt(getItemOrDefault('numCols', 5));
	let offsetMode = getItemOrDefault('offsetMode', 'vertical'); // 'horizontal' or 'vertical'

	// State array to persist cell states
	let cellStates = [];
	
	function initStates() {
		cellStates = [];
		for (let r = 0; r < numRows; r++) {
			cellStates.push(new Array(numCols).fill().map(() => ({placed: false, multiplier: 0})));
		}
	}
	initStates();
	
	if (localStorage.getItem('cellStates') !== null) {
		try {
			cellStates = JSON.parse(localStorage.getItem('cellStates'));
		} catch (error) {
			initStates();
		}
	}
	
	if (localStorage.getItem('quality') !== null) {
		document.querySelector('#quality').selectedIndex = parseInt(localStorage.getItem('quality'));
	}

	function createCell(r, c) {
		const cell = document.createElement('div');
		cell.className = 'cell';
		cell.dataset.row = r;
		cell.dataset.col = c;

		// Initialize state
		if (cellStates[r][c].placed) {
			cell.classList.add('placed');
			updateCell(r, c, cell);
		}

		// Toggle on click
		cell.addEventListener('click', () => {
			cell.classList.toggle('placed');
			cellStates[r][c].placed = cell.classList.contains('placed');
			calculateResults();
			updateCells();
		});

		return cell;
	}
	
	function updateCells() {
		if (offsetMode === 'horizontal') {
			grid.querySelectorAll('.row').forEach((rowEl, r) => {
				const cells = rowEl.querySelectorAll('.cell');
				cells.forEach((cell, c) => {
					updateCell(r, c, cell);
				});
			});
		} else {
			grid.querySelectorAll('.column').forEach((rowEl, c) => {
				const cells = rowEl.querySelectorAll('.cell');
				cells.forEach((cell, r) => {
					updateCell(r, c, cell);
				});
			});
		}
	}
	
	function updateCell(r, c, cell) {
		const state = cellStates[r]?.[c];
		 // Reset background color and title
		cell.style.backgroundColor = "";
		cell.title = "";
		if (state?.placed) {
			let span = cell.querySelector('span');
			if (!span) {
				span = document.createElement('span');
				cell.appendChild(span);
			}
			const percent = (state.multiplier - 1) * 100;
			span.textContent = '+' + percent + '%';
			if (percent === 600) {
				cell.style.backgroundColor = "#a23333";
				cell.title = "Reactor cannot be automatically fueled!"
			}
		} else {
			const span = cell.querySelector('span');
			if (span) cell.removeChild(span);
		}
	}
	
	function clearCells() {
		grid.querySelectorAll('.row, .column').forEach((rowEl, r) => {
			const cells = rowEl.querySelectorAll('.cell');
			cells.forEach((cell, c) => {
				cell.classList.remove('placed');
				cellStates[r][c].placed = false;
			});
		});

		calculateResults();
		updateCells();
	}

	function createRow(rowIndex) {
		const row = document.createElement('div');
		row.className = 'row';
		if (rowIndex % 2 === 1 && offsetMode === 'horizontal') row.classList.add('offset-h');

		for (let c = 0; c < numCols; c++) {
			row.appendChild(createCell(rowIndex, c));
		}
		return row;
	}

	function createColumn(colIndex) {
		const col = document.createElement('div');
		col.className = 'column';
		if (colIndex % 2 === 1 && offsetMode === 'vertical') col.classList.add('offset-v');

		for (let r = 0; r < numRows; r++) {
			col.appendChild(createCell(r, colIndex));
		}
		return col;
	}

	function renderGrid() {
		grid.innerHTML = '';
		grid.className = 'grid ' + (offsetMode === 'vertical' ? 'vertical' : 'horizontal');

		if (offsetMode === 'horizontal') {
			for (let r = 0; r < numRows; r++) {
				grid.appendChild(createRow(r));
			}
		} else {
			for (let c = 0; c < numCols; c++) {
				grid.appendChild(createColumn(c));
			}
		}
	}

	function addRow() {
		numRows++;
		// Add new row to state
		cellStates.push(new Array(numCols).fill().map(() => ({placed: false, multiplier: 0})));
		storePersistence();
		renderGrid();
	}

	function removeRow() {
		if (numRows > 1) {
			numRows--;
			cellStates.pop();
			calculateResults();
			renderGrid();
		}
	}

	function addColumn() {
		numCols++;
		// Add new column state to each row
		cellStates.forEach(row => row.push({placed: false, multiplier: 0}));
		storePersistence();
		renderGrid();
	}

	function removeColumn() {
		if (numCols > 1) {
			numCols--;
			cellStates.forEach(row => row.pop());
			calculateResults();
			renderGrid();
		}
	}

	function toggleOffsetMode() {
		offsetMode = offsetMode === 'horizontal' ? 'vertical' : 'horizontal';
		document.querySelector('#toggleoffsetmode').textContent = offsetMode === 'horizontal' ? 'Switch to Vertical' : 'Switch to Horizontal';
		calculateResults();
		renderGrid();
	}
	
	function calculateResults() {
		let total = 0;
		let count = 0;
		for (let r = 0; r < numRows; r++) {
			for (let c = 0; c < numCols; c++) {
				if (cellStates[r][c].placed) {
					let multiplier = 1;
					const neighbors = getNeighbors(r, c);
					for (const [nr, nc] of neighbors) {
						if (cellStates[nr]?.[nc]?.placed) {
							multiplier += 1;
						}
					}
					
					cellStates[r][c].multiplier = multiplier;
					total += multiplier;
					count++;
				} else {
					cellStates[r][c].multiplier = 0;
				}
			}
		}
		storePersistence();

		const quality = document.querySelector('#quality').value;
		const power = total * 100;

		document.querySelector('#power').textContent = `${(power * quality / 1000).toFixed(1)} GW`;
		document.querySelector('#reactors').textContent = `${count}`;
		document.querySelector('#generators').textContent = `${power / 50}`;
		document.querySelector('#fusioncells').textContent = `${(count * quality * 0.15).toFixed(2)}/m`;
		document.querySelector('#fluoroketone').textContent = `${count * 20} (${count}k units)`;
		document.querySelector('#hot_fluoroketone').textContent = `${(count * 4 * quality).toFixed(1)}/s`;
	}
	
	function storePersistence() {
		localStorage.setItem('cellStates', JSON.stringify(cellStates));
		localStorage.setItem('numRows', numRows);
		localStorage.setItem('numCols', numCols);
		localStorage.setItem('offsetMode', offsetMode);
		localStorage.setItem('quality', document.querySelector('#quality').selectedIndex);
	}

	function getNeighbors(r, c) {
		if (offsetMode === 'horizontal') {
			// Even row?
			const even = r % 2 === 0;
			return [
				[r, c - 1], [r, c + 1],			// left, right
				[r - 1, c], [r + 1, c],			// up, down
				[r - 1, c + (even ? -1 : 1)],	// upper diagonal left or right depending on row
				[r + 1, c + (even ? -1 : 1)]	// lower diagonal left or right
			];
		} else {
			// vertical offset mode
			const even = c % 2 === 0;
			return [
				[r - 1, c], [r + 1, c],			// up, down
				[r, c - 1], [r, c + 1],			// left, right
				[r + (even ? -1 : 1), c - 1],	// diagonal left up/down depending on col parity
				[r + (even ? -1 : 1), c + 1]	// diagonal right up/down
			];
		}
	}

	calculateResults();
	renderGrid();
</script>

</body>
</html>
